# Сбор телеметрии с браузера

Отслеживание активности пользователей включает в себя мониторинг поведения и взаимодействия пользователей с целевым
веб-приложением. На основе собранных данных владельцы веб-сайтов могут принимать различные решения в области рекламы,
пользовательского опыта или безопасности.

## Виды показателей

Собирать с веб-страницы можно огромное количество различных событий. Ограничением выступает лишь возможности принимающей
стороны (как правило, CRM или система аналитики) и платформы, на которой размещена ИС (в том числе язык
программирования). Среди показателей можно выделить следующие базовые действия:

- клик по элементу
- переход по ссылке
- заполнение форм или отдельных полей
- события аутентификации

Однако, данный список сильно упрощен, так как, при должном уровне технического вмешательства, возможно отслеживать любые
события в браузере. Язык JavaScript позволяет разработчикам отслеживать любые события на веб-странице для большинства
элементов, полный перечень можно найти
здесь: [введение в браузерные события](https://learn.javascript.ru/introduction-browser-events).

## Существующие подходы

Существует два типа действий пользователя, которые возможно отслеживать всем владельцам сайтов: посещения URL-адресов,
чтобы увидеть, на какие веб-страницы переходят пользователи, и действия, такие как нажатие кнопок или ввод текста, чтобы
увидеть, как пользователи взаимодействуют со страницей.

Самым популярным инструментом для данной работы на данный момент является Google Analytics или Яндекс.Метрика (для
российского рынка). Хотя GA предоставляет множество полезных показателей, таких как трафик в реальном времени, просмотры
страниц, сеансы и процент отказов, он имеет большие ограничения, когда дело доходит до отслеживания действий
пользователей, что затрудняет поиск проблем с пользовательским опытом, которые снижают конверсию.

Процесс мониторинга происходит следующим образом:

- Сперва GA требует от вас (как от владельца/разработчика ИС) вручную настроить отслеживание каждого элемента, который
  вы хотите анализировать, например кнопки или текстовые поля. GA начинает собирать данные о взаимодействии после
  настройки отслеживания, поэтому всегда есть задержка между осознанием того, что вам нужно проанализировать конкретное
  действие, и получением данных для этого.
- GA может показать вам, что большинство пользователей не завершают оформление заказа после добавления товара в корзину.
  Однако вы можете только догадываться, почему так происходит, поскольку нет возможности просмотреть сессии этих
  пользователей и увидеть каждое взаимодействие в них. Для этого нужны записи сессий, которые GA не предлагает.

Существует также огромное количество прочих решений, предлагающих схожий
функционал: [примерный список](https://blog.hubspot.com/sales/website-activity)

Помимо полноценных аналитических платформ также существует и OpenSource
решение [interactor](https://github.com/greenstick/interactor). Данное решение позволяет отслеживать большой перечень JS
событий и передавать их на удаленный сервер. Также есть [демонстрация](https://www.benjamincordier.com/interactor/)
работы приложения.

Наиболее гибкий подход - модификация исходного кода и прослушивание событий напрямую от желаемых элементов страницы.

### Мониторинг действий

Мониторинг действий на веб-странице возможно проводить несколькими способами:

Первый способ - внедрение на веб-странице специального скрипта для прослушивания определенных событий на странице, как в
примере с  [interactor](https://github.com/greenstick/interactor). Такой подход является наиболее простым, но также
менее удобным для обработки и настройки, так как передаваться будут все события с перечисленным типом. Все события затем
передаются на сервер мониторинга для хранения и последующей обработки.

Второй способ - установка прослушивания на определенные элементы на странице и сбор событий с них. Например, установить
прослушивание событий с кнопки для передачи введенных значений. Такой способ более сложен с точки зрения имплементации,
однако предлагает наиболее гибкую настройку собираемых событий, если их перечень ограничен.

Во всех случаях подразумевается внедрение нового кода в структуру приложения. Как правило, для первого способа
необходимо внедрение JS кода на корневом уровне HTML страницы. Для второго же требуется модификация всех точек сбора
данных и дополнительный импорт кода для передачи данных к каждому файлу, содержащему анализируемый HTML компонент.

Для передачи событий возможно использовать любую библиотеку для отправки HTTP запросов, таких
как [AJAX](https://developer.mozilla.org/ru/docs/Glossary/AJAX) или библиотеки, по
типу [axios](https://axios-http.com/ru/). Со стороны сервера также необходимо предусмотреть схему передачи и
соответствующий интерфейс API.

Для примера, возможно подготовить следующий интерфейс REST API, `/monitoring/event`, включающий исчерпывающий набор
полей для последующей обработки:

```json
{
  "user_session_id": "1234567abcd",
  "user_id": "123",
  "user_source_ip": "1.2.3.4",
  "event_type": "btn-click",
  "event_message": "clicked button 1 time",
  "event_element": "#sidebar-quicklinks > nav > div > div.sidebar-body > ol > ol > li:nth-child(9) > em > a",
  "event_timestamp_unix": "1712149848"
}
```

Для внутренних переходов также возможно предусмотреть следующую схему и интерфейс `/monitoring/href`:

```json
{
  "user_session_id": "1234567abcd",
  "user_id": "123",
  "user_source_ip": "1.2.3.4",
  "redirect_source": "https://example.com/page1",
  "redirect_target": "https://example.com/page2",
  "event_message": "user redirected",
  "event_element": "#sidebar-quicklinks > nav > div > div.sidebar-body > ol > ol > li:nth-child(9) > em > a",
  "event_timestamp_unix": "1712149848"
}
```

Для событий открытия или закрытия страницы также
существуют [события](https://developer.mozilla.org/en-US/docs/Web/API/Window/beforeunload_event) JS, которые можно
отслеживать на интерфейсе `/monitoring/visits`:

```json
{
  "user_session_id": null,
  "user_id": null,
  "user_source_ip": "1.2.3.4",
  "page_url": "https://example.com/init_page",
  "event_message": "new user visited the website",
  "event_timestamp_unix": "1712149848"
}
```

> В данном случае, пример для неавторизованного пользователя, который только зашел на веб-страницу.

## Обработка собранных событий

Для последующей обработки собранных событий потребуется применение токенизация пользовательского ввода. Например,
события нажатия на определенный элемент на странице будет токенизировано меткой A, в то время как событие отправки формы
будет токенизировано меткой Б. Затем, используя алгоритмы машинного обучения, в частности производя Embedding с
применением словарей, можно создавать векторы пользовательских действий на веб-странице и анализировать на наличие
определенных поведенческих особенностей.

Для создания такого вектора из базы данных событий необходимо будет извлекать последовательности из одной сессии и
кодировать события из них в едином формате, в зависимости от задачи исследования. Также для составления полной истории
действий пользователя можно использовать данные из всех источников событий, отфильрованных по IP или ID пользователя.

Для подобного набора данных также возможно использовать различные техники работы с временными рядами, так как все
события также имеют временные метки.

## Отслеживание пользовательских сессий

Как правило, для хранения пользовательских сессий на веб-странице используется несколько общепринятых подходов:

Доступные на стороне клиента:

- local storage - хранит пользовательские данные в локальном хранилище браузера (не очищается при закрытии)
- session storage - хранит пользовательские данные в сессионном хранилище браузера (очищается при закрытии
  сессии/браузера/вкладки)

Доступные на стороне сервера:

- cookie header - хранит пользовательские данные в cookie хранилище браузера, управляется сервером

В каждом случае для отслеживания пользовательской сессии необходим сессионный идентификатор, такой как, например, ID
сессии или пользователя. Возможно также отслеживать сессию по полному значению ключа, в случае, если он не
модифицируется.

Кроме сессии, для идентификации пользователя можно также использовать его IP или цифровой отпечаток браузера (например,
с помощью библиотеки [fingerprintjs](https://github.com/fingerprintjs/fingerprintjs)).